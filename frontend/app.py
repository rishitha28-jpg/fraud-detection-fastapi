# import streamlit as st
# import requests

# # --------------------------------------------------
# # CONFIG
# # --------------------------------------------------
# API_URL = "https://fraud-detection-fastapi-ouqr.onrender.com/predict"
# HEALTH_URL = "https://fraud-detection-fastapi-ouqr.onrender.com/health"

# # --------------------------------------------------
# # PAGE CONFIG
# # --------------------------------------------------
# st.set_page_config(
#     page_title="Fraud Detection System",
#     layout="centered"
# )

# # --------------------------------------------------
# # HEADER
# # --------------------------------------------------
# st.title("üí≥ Fraud Detection System")
# st.caption("Real-time transaction risk assessment using Machine Learning")

# # --------------------------------------------------
# # BACKEND HEALTH CHECK
# # --------------------------------------------------
# with st.spinner("Checking system status..."):
#     try:
#         health = requests.get(HEALTH_URL, timeout=3)
#         if health.status_code == 200:
#             st.success("üü¢ Fraud Detection API is online")
#         else:
#             st.warning("üü° API reachable but unhealthy")
#     except Exception:
#         st.error("üî¥ Backend service is unavailable")

# st.divider()

# # --------------------------------------------------
# # USER INPUTS (ONLY BUSINESS INPUTS)
# # --------------------------------------------------
# amount = st.number_input(
#     "Transaction Amount (‚Çπ)",
#     min_value=0.0,
#     step=100.0,
#     value=500.0
# )

# hour = st.slider(
#     "Transaction Hour (0‚Äì23)",
#     min_value=0,
#     max_value=23,
#     value=12
# )

# # --------------------------------------------------
# # BUTTON ACTION
# # --------------------------------------------------
# if st.button("Check Fraud", disabled=(amount <= 0)):

#     # üî¥ IMPORTANT FIX: SEND ALL 7 FEATURES
#     payload = {
#         "amount": float(amount),
#         "hour": int(hour),

#         # Default engineered features (match training)
#         "feature_3": 1.0,
#         "feature_4": 0.0,
#         "feature_5": 0.5,
#         "feature_6": 3.0,
#         "feature_7": 0.0
#     }

#     try:
#         response = requests.post(API_URL, json=payload, timeout=10)

#         if response.status_code == 200:
#             result = response.json()

#             probability = result["probability"]
#             risk = result["risk_level"]

#             fraud_pct = round(probability * 100, 2)
#             safe_pct = round((1 - probability) * 100, 2)

#             # --------------------------------------------------
#             # DECISION LOGIC
#             # --------------------------------------------------
#             if risk == "LOW":
#                 decision = "üü¢ TRANSACTION APPROVED"
#                 action = "Proceed with transaction"
#                 color = st.success
#             elif risk == "MEDIUM":
#                 decision = "üü° REVIEW REQUIRED"
#                 action = "Perform OTP / manual verification"
#                 color = st.warning
#             else:
#                 decision = "üî¥ TRANSACTION BLOCKED"
#                 action = "Block and escalate to fraud team"
#                 color = st.error

#             st.divider()

#             st.subheader(decision)

#             col1, col2, col3 = st.columns(3)
#             col1.metric("Risk Level", risk)
#             col2.metric("Fraud Probability", f"{fraud_pct}%")
#             col3.metric("Confidence (Safe)", f"{safe_pct}%")

#             st.subheader("üîç Risk Factors")

#             if amount >= 100000:
#                 st.write("‚ö† High transaction amount")
#             else:
#                 st.write("‚úî Normal transaction amount")

#             if hour < 6 or hour > 22:
#                 st.write("‚ö† Unusual transaction timing")
#             else:
#                 st.write("‚úî Normal transaction timing")

#             st.subheader("‚û° Recommended Action")
#             color(action)

#         else:
#             st.error(f"API Error ({response.status_code})")
#             st.code(response.text)

#     except requests.exceptions.Timeout:
#         st.error("‚è± Request timed out")
#     except requests.exceptions.ConnectionError:
#         st.error("‚ùå Unable to reach backend service")
#     except Exception as e:
#         st.error("Unexpected error occurred")
#         st.code(str(e))

# # --------------------------------------------------
# # DISCLAIMER
# # --------------------------------------------------
# st.divider()
# st.caption(
#     "‚ö†Ô∏è This output is generated by a machine learning model and is intended "
#     "as a decision-support tool. Final decisions should follow business, risk, "
#     "and compliance policies."
# )
import streamlit as st
import requests
from datetime import datetime
import uuid
import time

# --------------------------------------------------
# CONFIG
# --------------------------------------------------
API_URL = "https://fraud-detection-fastapi-ouqr.onrender.com/predict"
HEALTH_URL = "https://fraud-detection-fastapi-ouqr.onrender.com/health"
FRAUD_THRESHOLD = 50  # %

# --------------------------------------------------
# PAGE CONFIG
# --------------------------------------------------
st.set_page_config(
    page_title="Enterprise Fraud Detection Console",
    layout="centered"
)

# --------------------------------------------------
# HEADER
# --------------------------------------------------
st.title("üí≥ Enterprise Fraud Detection Console")
st.caption("Real-time, explainable transaction risk assessment powered by Machine Learning")

# --------------------------------------------------
# HEALTH CHECK
# --------------------------------------------------
with st.spinner("Checking system status..."):
    try:
        health = requests.get(HEALTH_URL, timeout=3)
        if health.status_code == 200:
            st.success("üü¢ Fraud Detection API Operational")
        else:
            st.warning("üü° API reachable but unhealthy")
    except Exception:
        st.error("üî¥ Backend service unavailable")

st.divider()

# --------------------------------------------------
# INPUT SECTION
# --------------------------------------------------
st.subheader("Transaction Details")

amount = st.number_input(
    "Transaction Amount (‚Çπ)",
    min_value=0.0,
    step=100.0,
    value=500.0
)

hour = st.slider(
    "Transaction Hour (0‚Äì23)",
    min_value=0,
    max_value=23,
    value=12
)

# --------------------------------------------------
# FRAUD CHECK BUTTON
# --------------------------------------------------
if st.button("üîç Analyze Transaction", disabled=(amount <= 0)):

    payload = {
        "amount": float(amount),
        "hour": int(hour),
        "feature_3": 1.0,
        "feature_4": 0.0,
        "feature_5": 0.5,
        "feature_6": 3.0,
        "feature_7": 0.0
    }

    try:
        start_time = time.time()
        response = requests.post(API_URL, json=payload, timeout=10)
        latency_ms = int((time.time() - start_time) * 1000)

        if response.status_code == 200:
            result = response.json()

            probability = result["probability"]
            risk = result["risk_level"]

            fraud_pct = round(probability * 100, 2)
            confidence_pct = round((1 - probability) * 100, 2)

            trace_id = f"FRD-{datetime.now().strftime('%Y%m%d-%H%M%S')}-{str(uuid.uuid4())[:4].upper()}"

            # --------------------------------------------------
            # RISK BAND LOGIC
            # --------------------------------------------------
            if fraud_pct <= 10:
                risk_band = "0‚Äì10% (Very Low)"
            elif fraud_pct <= 30:
                risk_band = "10‚Äì30% (Low)"
            elif fraud_pct <= 60:
                risk_band = "30‚Äì60% (Medium)"
            else:
                risk_band = "60‚Äì100% (High)"

            # --------------------------------------------------
            # DECISION + POLICY
            # --------------------------------------------------
            if risk == "LOW":
                decision_text = "üü¢ Approved ‚Äî Low Fraud Risk"
                decision_code = "FRD_APPROVE_LOW_RISK"
                policy = "AUTO_APPROVE_V1"
                action_text = "Auto-approve transaction ‚Äî No customer verification required"
                decision_display = st.success
            elif risk == "MEDIUM":
                decision_text = "üü° Review Required ‚Äî Medium Fraud Risk"
                decision_code = "FRD_REVIEW_REQUIRED"
                policy = "STEP_UP_VERIFICATION_V2"
                action_text = "Perform step-up verification (OTP / 2FA)"
                decision_display = st.warning
            else:
                decision_text = "üî¥ Blocked ‚Äî High Fraud Risk"
                decision_code = "FRD_BLOCK_HIGH_RISK"
                policy = "BLOCK_AND_ESCALATE_V3"
                action_text = "Block transaction and escalate to fraud investigation team"
                decision_display = st.error

            st.divider()

            # --------------------------------------------------
            # DECISION HEADER
            # --------------------------------------------------
            decision_display(decision_text)
            st.caption(f"Decision Code: {decision_code}")
            st.caption(f"Trace ID: {trace_id}")

            # --------------------------------------------------
            # KPI METRICS
            # --------------------------------------------------
            col1, col2, col3 = st.columns(3)
            col1.metric("Risk Level", risk)
            col2.metric("Fraud Probability", f"{fraud_pct}%")
            col3.metric("Model Confidence", f"{confidence_pct}%")

            st.caption("Confidence represents model certainty based on historical fraud patterns.")

            # --------------------------------------------------
            # FRAUD RISK GAUGE
            # --------------------------------------------------
            st.subheader("Fraud Risk Indicator")
            st.progress(min(int(fraud_pct), 100))
            st.caption(f"Risk Band: {risk_band}")
            st.caption(f"Decision Threshold: {FRAUD_THRESHOLD}% | Current Risk: {fraud_pct}%")

            # --------------------------------------------------
            # KEY RISK SIGNALS
            # --------------------------------------------------
            st.subheader("Key Risk Signals")

            if amount >= 100000:
                st.write(f"‚ö† High transaction amount detected (‚Çπ{amount})")
            else:
                st.write(f"‚úî Amount within expected behavioral range (‚Çπ{amount})")

            if hour < 6 or hour > 22:
                st.write(f"‚ö† Transaction occurred outside normal hours ({hour}:00)")
            else:
                st.write(f"‚úî Transaction timing consistent with user history ({hour}:00)")

            # --------------------------------------------------
            # RECOMMENDED ACTION
            # --------------------------------------------------
            st.subheader("Recommended Action")
            decision_display(action_text)
            st.caption(f"Policy Applied: {policy}")

            # --------------------------------------------------
            # SYSTEM METADATA
            # --------------------------------------------------
            st.subheader("System Metadata")
            st.caption(
                f"""
                Model: FraudNet-XGBoost v1.3  
                Prediction Latency: {latency_ms} ms (SLA < 100 ms)  
                Monitoring: Enabled (Drift, Accuracy, Latency)  
                Decision Time: {datetime.now().strftime('%d %b %Y, %H:%M:%S')}
                """
            )

        else:
            st.error(f"API Error ({response.status_code})")
            st.code(response.text)

    except requests.exceptions.Timeout:
        st.error("‚è± Request timed out")
    except requests.exceptions.ConnectionError:
        st.error("‚ùå Unable to reach backend service")
    except Exception as e:
        st.error("Unexpected error occurred")
        st.code(str(e))

# --------------------------------------------------
# COMPLIANCE DISCLAIMER
# --------------------------------------------------
st.divider()
st.caption(
    "‚ö† This decision is generated by an ML-based fraud risk model and is intended "
    "for decision support purposes only. Final authorization must comply with "
    "business, risk, and regulatory policies."
)